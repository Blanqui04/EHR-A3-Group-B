
# VIF = 1 / (1 - R²) where R² is from auxiliary regression

vif_manual <- function(model_object) {
  # Get the model matrix (X variables including dummy variables)
  X <- model.matrix(model_object)
  
  # Remove intercept column
  X <- X[, -1]
  
  # Get column names
  col_names <- colnames(X)
  
  # For each predictor, fit auxiliary linear regression
  vif_values <- numeric(ncol(X))
  
  for (i in 1:ncol(X)) {
    # Escape column names with backticks for formula
    response_var <- paste0("`", col_names[i], "`")
    predictor_vars <- paste0("`", col_names[-i], "`", collapse=" + ")
    
    # Create formula with escaped names
    aux_formula <- as.formula(paste(response_var, "~", predictor_vars))
    aux_model <- lm(aux_formula, data=as.data.frame(X))
    
    # Extract R-squared
    r_squared <- summary(aux_model)$r.squared
    
    # Calculate VIF
    vif_values[i] <- 1 / (1 - r_squared)
  }
  
  # Return VIF results by main predictor group
  vif_results <- data.frame(
    Predictor = col_names,
    VIF = vif_values
  )
  
  return(vif_results)
}

# Calculate VIF
vif_results <- vif_manual(logistic)

cat("Variance Inflation Factors (VIF) for All Predictors:\n")
cat("================================================\n")
print(vif_results)
cat("\n")

# Aggregate VIF by main predictor (average across dummy variables)
library(dplyr)
library(stringr)

# Extract main predictor name (part before first number or special character)
vif_results_agg <- vif_results %>%
  mutate(
    main_predictor = case_when(
      Predictor == "age" ~ "age",
      Predictor == "genderM" ~ "gender",
      str_detect(Predictor, "^ethnicity") ~ "ethnicity",
      str_detect(Predictor, "^insurance") ~ "insurance",
      str_detect(Predictor, "^icd9_code") ~ "icd9_code",
      TRUE ~ Predictor
    )
  ) %>%
  group_by(main_predictor) %>%
  summarise(VIF_avg = mean(VIF), .groups = "drop") %>%
  rename(Predictor = main_predictor, VIF = VIF_avg)

cat("\nAggregated VIF by Main Predictor:\n")
cat("================================================\n")
print(vif_results_agg)
cat("\n")

# Identify high VIF values (VIF > 5)
high_vif <- vif_results_agg[vif_results_agg$VIF > 5, ]
if(nrow(high_vif) > 0) {
  cat("Predictors with VIF > 5 (potential multicollinearity):\n")
  print(high_vif)
} else {
  cat("No predictors with VIF > 5. No multicollinearity concern.\n")
}
